/*  Global constant  */
//  Current Path constant
const currentPath = window.location.pathname;
/*

  Content Animation
  (Cross-browser compatible)

*/
/*  Main Template Content animation */
//  Cache load-in elements
const $load = document.getElementsByClassName('js-load')[0];
const $scale = document.getElementsByClassName('js-scale')[0];
if (window.attachEvent) {
  window.attachEvent('onload', function(){
    $load.classList.remove('is-hidden');
    $load.classList.add('is-visible');
    if (currentPath != '/error' || currentPath != '/aplicacion-enviada') {
      $scale.classList.remove('is-tiny');
      $scale.classList.add('is-normal');
    }
  });
}
else if (window.addEventListener) {
  window.addEventListener('load', function(){
    $load.classList.remove('is-hidden');
    $load.classList.add('is-visible');
    if (currentPath != '/error' || currentPath != '/aplicacion-enviada') {
      $scale.classList.remove('is-tiny');
      $scale.classList.add('is-normal');
    }
  });
}
/*! getEmPixels  | Author: Tyson Matanich (http://matanich.com), 2013 | License: MIT */
(function (document, documentElement) {
  // Enable strict mode
  "use strict";
  // Form the style on the fly to result in smaller minified file
  var important = "!important;";
  var style = "position:absolute" + important + "visibility:hidden" + important + "width:1em" + important + "font-size:1em" + important + "padding:0" + important;
  window.getEmPixels = function (element) {
    var extraBody;
    if (!element) {
      // Emulate the documentElement to get rem value (documentElement does not work in IE6-7)
      element = extraBody = document.createElement("body");
      extraBody.style.cssText = "font-size:1em" + important;
      documentElement.insertBefore(extraBody, document.body);
    }
    // Create and style a test element
    var testElement = document.createElement("i");
    testElement.style.cssText = style;
    element.appendChild(testElement);
    // Get the client width of the test element
    var value = testElement.clientWidth;
    if (extraBody) {
      // Remove the extra body element
      documentElement.removeChild(extraBody);
    }
    else {
      // Remove the test element
      element.removeChild(testElement);
    }
    // Return the em value in pixels
    return value;
  };
}(document, document.documentElement));
/*

  Product Category Navigation
  (Cross-browser compatible)

*/
//  Cache Product Card nodes and carrusel.scrollLeft
//  Cache Product Card carrusel
//  x = containerWidth
//  Δ = delta = maximum scrollLeft value of product carrusel
//  y = carrusel.offsetWidth
//  |----- x -----||----- Δ -----|
//  |------------ y -------------|
const containerWidth = getEmPixels() * 64.5;
const $carrusel = document.getElementById('carrusel');
const delta = $carrusel.offsetWidth - containerWidth;
const $cards = document.getElementsByClassName('js-card');
var carruselScroll = $carrusel.scrollLeft;
//  Cache list of product categories
<%# Config %>
<% categories = [] %>
<% data.products.categories.each do |category| %>
  <% categories.push(category.name.downcase) %>
<% end %>
<%# End %>
const categories = <%= categories %>;
//  Category object with offset values of first product card under that category
var Categories = new Object();
for (var c = 0; c < categories.length; c++) {
  for (var i = 0; i < $cards.length; i++) {
    if ($cards[i].dataset.category === categories[c]) {
      Categories[categories[c]] = $cards[i].offsetLeft;
      break;
    }
  }
}
//  Creating click event listener for category carrusel
const $categories = document.getElementsByClassName('js-category');
for (var c = 0; c < $categories.length; c++) {
  if (window.attachEvent) {
    $categories[c].attachEvent('onclick', function(){
      clearNav();
      activateNav(this);
      scrollTo(this.innerHTML);
    });
  }
  else if (window.addEventListener) {
    $categories[c].addEventListener('click', function(){
      clearNav();
      activateNav(this);
      scrollTo(this.innerHTML);
    });
  }
}
//  Removes `.blue` active class and adds `.gray` default class to product category linkn
function clearNav() {
  for (var c = 0; c < $categories.length; c++) {
    $categories[c].classList.remove('blue');
    $categories[c].classList.add('gray');
  }
}
//  Adds '.blue' to clicked navigation link
function activateNav($element) {
  $element.classList.add('blue');
}
function scrollTo(category) {
  //  Source: StackOverflow -> Smoothly Scolling to Element Using Vanilla JS
  //  Path: http://stackoverflow.com/questions/36619959/smoothly-scrolling-to-element-using-vanilla-javascript
  //
  const xValue = Categories[category.toLowerCase()];
  const from = $carrusel.scrollLeft;
  const by = (xValue - 24) - $carrusel.scrollLeft;
  var currentIteration = 0;
  /**
   * get total iterations
   * 60 -> requestAnimationFrame 60/second
   * second parameter -> time in seconds for the animation
   **/
  var animIterations = Math.round(60 * 0.5);
  (function scroll() {
      var value = easeOutCubic(currentIteration, from, by, animIterations);
      $carrusel.scrollLeft = value;
      carruselScroll = $carrusel.scrollLeft;
      currentIteration++;
      if (currentIteration < animIterations) {
        requestAnimationFrame(scroll);
      }
  })();
}
//  Ease-out Cubic animation function
function easeOutCubic(currentIteration, startValue, changeInValue, totalIterations) {
    return changeInValue * (Math.pow(currentIteration / totalIterations - 1, 3) + 1) + startValue;
}
/*

  Product Card Desktop Navigation
  (Cross-browser compatible)

*/
if (currentPath === "/") {
  const $previous = document.getElementsByClassName('js-previous')[0];
  const $next = document.getElementsByClassName('js-next')[0];
  if (window.attachEvent) {
    $previous.attachEvent('onclick', function(){
      //  Add functions
    });
    $next.attachEvent('onclick', function(){
      //  Add functions
    });
  }
  else if (window.addEventListener) {
    $previous.addEventListener('click', function(){
      console.log('previous');
      console.log(carruselScroll);
    });
    $next.addEventListener('click', function(){
      console.log('next');
      console.log(carruselScroll);
    });
  }
}
function direction(value) {

}
/*

  Product Card Interaction
  (Cross-browser compatible)

*/
//  Add an Event Listener for each Product Card
for (var c = 0; c < $cards.length; c++) {
  if (window.attachEvent) {
    $cards[c].attachEvent('onclick', function(){
      updateCard(this);
    });
  }
  else if (window.addEventListener) {
    $cards[c].addEventListener('click', function(){
      updateCard(this);
    });
  }
}
//  Dispatches Product Card styling-animation functions: rotate and fade
function updateCard($card) {
  //  Cache arrow node
  var $arrow = $card.getElementsByClassName('js-rotate')[0];
  //  Rotate arrow
  rotate($arrow);
  //  Cache image and detail nodes
  var $image = $card.getElementsByClassName('js-fade')[0];
  var $detail = $card.getElementsByClassName('js-fade')[1];
  //  If image is visible, fade image and delay-fade detail
  if (hasClass($image, 'is-visible')) {
    fade($image);
    setTimeout(function(){
      fade($detail)
    }, 225);
  //  Else, fade detail and delay-fade image
  } else {
    fade($detail);
    setTimeout(function(){
      fade($image)
    }, 225);
  }
}
//  Toggle rotation classes
function rotate($node) {
  $node.classList.toggle('is-up');
  $node.classList.toggle('is-down');
}
//  Toggle fade classes
function fade($node) {
  $node.classList.toggle('is-visible');
  $node.classList.toggle('is-hidden');
}
//  Returns Boolean indicating presence of class in element
function hasClass($node, cls) {
  return (' ' + $node.className + ' ').indexOf(' ' + cls + ' ') > -1;
}
/*

  Dynamic Content
  (Cross-browser compatible)

*/
//  Time Variables
var today = new Date(),
    currentYear = today.getFullYear(),
    currentMonth = today.getMonth(),
    currentDayOfWeek = today.getDay(),
    currentDay = today.getDate(),
    currentDate = "" + currentDay + "/" + (currentMonth + 1) + "/" + currentYear,
    currentHour = today.getHours(),
    currentMinutes = today.getMinutes(),
    currentTime = currentHour + (currentMinutes / 59),
    currentDayType;
//  Half and Full Holiday List
<%# Configuration %>
<% half_holiday = [] %>
<% full_holiday = [] %>
<% data.contact.holidays.each do |holiday| %>
  <% if holiday.is_half_day %>
    <% half_holiday.push(holiday.date) %>
  <% else %>
    <% full_holiday.push(holiday.date) %>
  <% end %>
<% end %>
<%# End %>
const half_holidays = <%= half_holiday %>;
const full_holidays = <%= full_holiday %>;
//  Current Day Type & Time Variables
var currentDayType, currentDayTime;
//  Sets type of current day
function setCurrentDayType() {
  //  Half Holiday setter
  for (var h = 0; h < half_holidays.length; h++) {
    if (half_holidays[h] === currentDate) {
      currentDayType = "Half Day";
      return currentDayType;
    }
  }
  //  Full Holiday setter
  for (var h = 0; h < full_holidays.length; h++) {
    if (full_holidays[h] === currentDate) {
      currentDayType = "Rest Day";
      return currentDayType;
    }
  }
  //  Work Day setter
  if ((1 <= currentDayOfWeek) && (currentDayOfWeek <= 5)) {
    currentDayType = "Full Day";
    return currentDayType;
  }
  //  Half Day setter
  else if (currentDayOfWeek === 6) {
    currentDayType = "Half Day";
    return currentDayType;
  }
  //  Rest Day setter
  else {
    currentDayType = "Rest Day";
    return currentDayType;
  }
}
//  Updates current day time
<%# Config %>
<% weekdays = data.contact.schedules[0].hours %>
<% saturdays = data.contact.schedules[1].hours %>
<%# End %>
function setCurrentDayTime() {
  var status = "Closed";
  //  If status is Rest Day, return "Closed"
  if (setCurrentDayType() === "Rest Day") {
    return status;
  }
  //  Hours of Operation
  const fullDayOpen = (((<%= weekdays.opens %> <= currentTime) && (currentTime < <%= weekdays.lunch %>)) || ((<%= weekdays.afternoon %> <= currentTime) && (currentTime < <%= weekdays.closes %>)));
  const fullDayLunch = ((<%= weekdays.lunch %> <= currentTime) && (currentTime < <%= weekdays.afternoon %>))
  const halfDayOpen = ((<%= saturdays.opens %> <= currentTime) && (currentTime < <%= saturdays.closes %>));
  //  Cache Hours of Operation values
  const statuses = [fullDayOpen, fullDayLunch, halfDayOpen];
  //  Status index
  var status_index = 3;
  //  Status value checker
  for (var s = 0; s < statuses.length; s++) {
    if (statuses[s]) {
      status_index = s;
      break;
    }
  }
  //  Status setter
  switch(status_index) {
    case 0:
      status = "Open";
      break;
    case 1:
      status = "Lunch";
      break;
    case 2:
      status = "Closed";
      break;
    default:
      status = "Closed";
  }
  return status;
}
//  Updates dynamic content first based on office status, then based on day type.
function updateDynamicContent(officeStatus, dayType) {
  //  Set dynamic content to "Closed"
  if (officeStatus === "Closed") {
    navStatus("Closed");
    navAction("Closed");
    mobileAction("Closed");
    if (currentPath === '/') {
      contactSection("Closed");
    }
    if (currentPath === '/empresa') {
      aboutContent("Closed");
    }
    if (currentPath.includes('aplicacion')) {
      applicationContent("Closed");
    }
  }
  //  Set dynamic content to "Lunch"
  if (officeStatus === "Lunch" && dayType === "Full Day") {
    navStatus("Lunch");
    navAction("Lunch");
    mobileAction("Lunch");
    if (currentPath === '/') {
      contactSection("Lunch");
    }
    if (currentPath === '/empresa') {
      aboutContent("Lunch");
    }
    if (currentPath.includes('aplicacion')) {
      applicationContent("Lunch");
    }
  }
}
//  Updates nav status
function navStatus(status) {
  //  Cache status icon and text
  const $status = document.getElementById('status');
  const $text = document.getElementById('status-text');
  //  Set status to "Closed"
  if (status === "Closed") {
    $status.classList.toggle('bg-green');
    $status.classList.toggle('bg-red');
    $text.innerHTML = "<%= data.contact.status.closes.title %>";
  }
  //  Set status to "Lunch"
  if (status === "Lunch") {
    $status.classList.toggle('bg-green');
    $status.classList.toggle('bg-orange');
    $text.innerHTML = "<%= data.contact.status.lunch.title %>";
  }
}
//  Updates nav action button
function navAction(status) {
  //  Cache action button
  const $button = document.getElementById('nav-action');
  //  Set button to "Closed" / "Lunch" status
  if (status === "Closed" || status === "Lunch") {
    $button.classList.toggle('bg-green');
    $button.classList.toggle('bg-blue');
    $button.classList.toggle('hover-bg-dark-green');
    $button.classList.toggle('hover-bg-dark-blue');
    $button.href = "<%= data.contact.button.closes.href %><%= data.contact.email %>";
    $button.innerHTML = "<%= data.contact.button.closes.title %>";
  }
}
//  Updates mobile contact button
function mobileAction(status) {
  //  Cache mobile contact button
  const $button = document.getElementsByClassName('js-mobile')[0];
  //  Set button to "Closed" / "Lunch" status
  if (status === "Closed" || status === "Lunch") {
    $button.classList.toggle('bg-green');
    $button.classList.toggle('bg-blue');
    $button.setAttribute('href', 'mailto:<%= data.contact.email %>');
    $button.style.backgroundImage = "url('../../images/icons/mensaje.svg')";
  }
}
//  Updates About content
function aboutContent(status) {
  //  Cache about status span
  const $about = document.getElementsByClassName('js-about')[0];
  const $contact = document.getElementsByClassName('js-contact')[0];
  const $remove = document.getElementsByClassName('js-remove')[0];
  //  Set innerHTML to "Closed" / "Lunch" status
  if (status === "Closed") {
    $about.innerHTML = '<%= data.about.contact.closes %>';
    $contact.removeChild($remove);
  }
  else if (status === "Lunch") {
    $about.innerHTML = '<%= data.about.contact.lunch %>';
    $contact.removeChild($remove);
  }
}
//  Updates Application content
function applicationContent(status) {
  //  Cache application information span
  const $application = document.getElementsByClassName('js-application')[0];
  //  Set innerHTML to "Closed"
  if (status === "Closed") {
    $application.innerHTML = '<%= data.jobs.application.closes %>';
  }
  else if (status === "Lunch") {
    $application.innerHTML = '<%= data.jobs.application.lunch %>';
  }
}
//  Updates Index Contact Section
function contactSection(status) {
  //  Cache section subtitle, phone, and schedule title nodes
  const $subtitle = document.getElementsByClassName('js-subtitle')[0];
  const $phone = document.getElementsByClassName('js-phone')[0];
  const $schedule = document.getElementsByClassName('js-schedule')[0];
  //  Set subtitle, phone, and schedule to "Closed"
  if (status === "Closed") {
    $subtitle.innerHTML = '<%= data.index.contact.subtitle.closes %>';
    $phone.classList.remove('blue');
    $phone.classList.remove('hover-dark-blue');
    $phone.classList.add('gray');
    $phone.removeAttribute('href');
    $schedule.innerHTML = '<%= data.contact.section.schedule.closes %>';
  }
  //  Set subtitle, phone, and schedule to "Lunch"
  if (status === "Lunch") {
    $subtitle.innerHTML = '<%= data.index.contact.subtitle.lunch %>';
    $phone.classList.remove('blue');
    $phone.classList.remove('hover-dark-blue');
    $phone.classList.add('gray');
    $phone.removeAttribute('href');
    $schedule.innerHTML = '<%= data.contact.section.schedule.lunch %>';
  }
}
//  Updating dynamic content
updateDynamicContent(setCurrentDayTime(), setCurrentDayType());
